@page "/chains/{chainId:guid}"
@using StoreManager.Webapp.Client.Models.Chain.Query
@using StoreManager.Webapp.Client.Models.Store.Query
@using StoreManager.Webapp.Client.Services
@rendermode InteractiveWebAssembly
@inject IChainService ChainService
@inject NavigationManager Navigation

<PageTitle>Chain Details</PageTitle>

<div class="container-fluid mt-4">
    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading chain details...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @errorMessage
        </div>
        <button class="btn btn-secondary" @onclick='() => Navigation.NavigateTo("/chains")'>
            Back to Chains
        </button>
    }
    else if (chain == null)
    {
        <div class="alert alert-warning">
            Chain not found.
        </div>
        <button class="btn btn-secondary" @onclick='() => Navigation.NavigateTo("/chains")'>
            Back to Chains
        </button>
    }
    else
    {
        <!-- Chain Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-2">@chain.Name</h1>
                <small class="text-muted">ID: @chain.Id</small>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" @onclick="EditChain">
                    <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-secondary" @onclick='() => Navigation.NavigateTo("/chains")'>
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
        </div>

        <!-- Chain Information Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Chain Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Name:</strong>
                        <p>@chain.Name</p>
                    </div>
                    <div class="col-md-4">
                        <strong>Total Stores:</strong>
                        <p>
                            @if (chain.StoreCount.HasValue && chain.StoreCount > 0)
                            {
                                <span class="badge bg-primary">@chain.StoreCount stores</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No stores</span>
                            }
                        </p>
                    </div>
                    <div class="col-md-4">
                        <strong>Created:</strong>
                        <p>@chain.CreatedOn.ToString("yyyy-MM-dd HH:mm")</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stores Section -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-shop"></i> Associated Stores</h5>
                <button class="btn btn-sm btn-primary" @onclick='() => Navigation.NavigateTo($"/stores/create?chainId={ChainId}")'>
                    <i class="bi bi-plus-circle"></i> Add Store
                </button>
            </div>
            <div class="card-body">
                @if (chain.Stores == null || !chain.Stores.Any())
                {
                    <div class="alert alert-info">
                        No stores are currently associated with this chain.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Number</th>
                                    <th>Name</th>
                                    <th>Address</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var store in chain.Stores)
                                {
                                    <tr>
                                        <td><strong>#@store.Number</strong></td>
                                        <td>@store.Name</td>
                                        <td>
                                            @store.Street<br />
                                            <small class="text-muted">@store.PostalCode @store.City</small>
                                        </td>
                                        <td>@store.CountryCode @store.PhoneNumber</td>
                                        <td>@store.Email</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary"
                                                    @onclick='() => Navigation.NavigateTo($"/stores/{store.Id}")'>
                                                View
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid ChainId { get; set; }

    private QueryChainDto? chain;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadChainAsync();
    }

    private async Task LoadChainAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Get chain with stores
            chain = await ChainService.GetChainAndStores(ChainId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load chain: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void EditChain()
    {
        Navigation.NavigateTo($"/chains/edit/{ChainId}");
    }
}