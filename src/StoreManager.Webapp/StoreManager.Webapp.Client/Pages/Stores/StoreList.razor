@page "/stores"
@using StoreManager.Webapp.Client.Components.Shared
@using StoreManager.Webapp.Client.Models.Store.Query
@using StoreManager.Webapp.Client.Models.Store.Command
@using StoreManager.Webapp.Client.Models.Chain.Query
@using StoreManager.Webapp.Client.Services
@rendermode InteractiveWebAssembly
@inject IStoreService StoreService
@inject IChainService ChainService
@inject NavigationManager Navigation

<PageTitle>Stores</PageTitle>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Store Management</h1>
        <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/stores/create")'>
            <i class="bi bi-plus-circle"></i> Create New Store
        </button>
    </div>

    @if (isLoadingOptions)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading options...</p>
        </div>
    }
    else
    {
        <!-- Filter Card -->
        <div class="card mb-4 filter-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Filter Stores</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-10">
                        <label class="form-label">Select Store Type or Chain</label>
                        <InputSelect class="form-select form-select-lg" @bind-Value="selectedFilter" @bind-Value:after="OnFilterChanged">
                            <option value="">-- Select a filter --</option>
                            <option value="independent">🏪 Independent Stores</option>
                            <optgroup label="Chains">
                                @foreach (var chain in availableChains)
                                {
                                    <option value="chain_@chain.Id">🔗 @chain.Name (@chain.StoreCount store@(chain.StoreCount != 1 ? "s" : ""))</option>
                                }
                            </optgroup>
                        </InputSelect>
                    </div>
                    <div class="col-md-2">
                        @if (!string.IsNullOrEmpty(selectedFilter))
                        {
                            <button class="btn btn-outline-secondary btn-lg w-100" @onclick="ClearFilter">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        }
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(selectedFilter))
                {
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-info-circle"></i>
                        <strong>Showing:</strong>
                        @if (selectedFilter == "independent")
                        {
                            <span>Independent stores (not affiliated with any chain)</span>
                        }
                        else
                        {
                            var chainName = availableChains.FirstOrDefault(c => $"chain_{c.Id}" == selectedFilter)?.Name;
                            <span>Stores belonging to <strong>@chainName</strong></span>
                        }
                    </div>
                }
            </div>
        </div>

        @if (errorMessage != null)
        {
            <div class="alert alert-danger alert-dismissible fade show">
                <strong>Error:</strong> @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
            </div>
        }

        @if (string.IsNullOrEmpty(selectedFilter))
        {
            <div class="welcome-card">
                <div class="welcome-content">
                    <i class="bi bi-shop welcome-icon"></i>
                    <h3>Welcome to Store Management</h3>
                    <p>Select a filter above to view stores</p>
                    <ul class="feature-list">
                        <li><i class="bi bi-check-circle-fill"></i> View independent stores</li>
                        <li><i class="bi bi-check-circle-fill"></i> View stores by chain</li>
                        <li><i class="bi bi-check-circle-fill"></i> Manage store details</li>
                    </ul>
                </div>
            </div>
        }
        else if (isLoadingStores)
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Number</th>
                            <th>Name</th>
                            <th>Chain</th>
                            <th>Address</th>
                            <th>Contact</th>
                            <th>Manager</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < 5; i++)
                        {
                            <tr>
                                <td colspan="7">
                                    <div class="skeleton-loading">
                                        <div class="skeleton-line"></div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="text-center mt-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading stores...</span>
                    </div>
                    <p class="text-muted mt-2">Loading stores...</p>
                </div>
            </div>
        }
        else if (stores == null || !stores.Any())
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No stores found for this selection.
            </div>
        }
        else
        {
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list"></i> Stores (@stores.Count)
                    </h5>
                    @if (selectedFilter.StartsWith("chain_") && stores.Any())
                    {
                        <button class="btn btn-sm btn-danger" @onclick="ShowBulkDeleteConfirmation">
                            <i class="bi bi-trash-fill"></i> Delete All Stores from Chain
                        </button>
                    }
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Number</th>
                                    <th>Name</th>
                                    <th>Chain</th>
                                    <th>Address</th>
                                    <th>Contact</th>
                                    <th>Manager</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var store in stores)
                                {
                                    <tr>
                                        <td><strong>#@store.Number</strong></td>
                                        <td>@store.Name</td>
                                        <td>
                                            @if (store.ChainId.HasValue && store.ChainId != Guid.Empty)
                                            {
                                                var chain = availableChains.FirstOrDefault(c => c.Id == store.ChainId);
                                                if (chain != null)
                                                {
                                                    <span class="badge bg-primary">@chain.Name</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Unknown</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">Independent</span>
                                            }
                                        </td>
                                        <td>
                                            @store.Street<br />
                                            <small class="text-muted">@store.PostalCode @store.City</small>
                                        </td>
                                        <td>
                                            @store.CountryCode @store.PhoneNumber<br />
                                            <small class="text-muted">@store.Email</small>
                                        </td>
                                        <td>@store.FirstName @store.LastName</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary"
                                                        @onclick='() => Navigation.NavigateTo($"/stores/{store.Id}")'>
                                                    <i class="bi bi-eye"></i> View
                                                </button>
                                                <button class="btn btn-sm btn-success"
                                                        @onclick='() => Navigation.NavigateTo($"/stores/edit/{store.Id}")'>
                                                    <i class="bi bi-pencil"></i> Edit
                                                </button>
                                                <button class="btn btn-sm btn-danger"
                                                        @onclick="() => ShowDeleteConfirmation(store)">
                                                    <i class="bi bi-trash"></i> Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    }
</div>

<ConfirmationModal IsVisible="showDeleteModal"
                   Title="@modalTitle"
                   Message="@modalMessage"
                   CanConfirm="true"
                   OnConfirm="ConfirmDelete"
                   OnCancel="CancelDelete" />

@code {
    private List<QueryStoreDto> stores = new();
    private List<QueryChainDto> availableChains = new();
    private string selectedFilter = string.Empty;
    private bool isLoadingOptions = true;
    private bool isLoadingStores = false;
    private string? errorMessage;

    // Modal state
    private bool showDeleteModal = false;
    private QueryStoreDto? storeToDelete = null;
    private string modalTitle = string.Empty;
    private string modalMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadFilterOptions();
    }

    private async Task LoadFilterOptions()
    {
        try
        {
            isLoadingOptions = true;
            errorMessage = null;
            availableChains = await ChainService.GetAllChainsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load filter options: {ex.Message}";
        }
        finally
        {
            isLoadingOptions = false;
        }
    }

    private async Task OnFilterChanged()
    {
        if (string.IsNullOrEmpty(selectedFilter))
        {
            stores.Clear();
            return;
        }

        await LoadStores();
    }

    private async Task LoadStores()
    {
        try
        {
            isLoadingStores = true;
            errorMessage = null;
            stores.Clear();

            if (selectedFilter == "independent")
            {
                stores = await StoreService.GetAllIndependentStoresAsync();
            }
            else if (selectedFilter.StartsWith("chain_"))
            {
                var chainIdString = selectedFilter.Replace("chain_", "");
                if (Guid.TryParse(chainIdString, out var chainId))
                {
                    stores = await StoreService.GetStoresByChainAsync(chainId);
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load stores: {ex.Message}";
        }
        finally
        {
            isLoadingStores = false;
        }
    }

    private void ClearFilter()
    {
        selectedFilter = string.Empty;
        stores.Clear();
    }

    private void ShowDeleteConfirmation(QueryStoreDto store)
    {
        storeToDelete = store;
        modalTitle = "Confirm Deletion";
        modalMessage = $"Are you sure you want to delete the store '{store.Name}' (#{store.Number})? This action cannot be undone.";
        showDeleteModal = true;
    }

    private void ShowBulkDeleteConfirmation()
    {
        var chainName = availableChains.FirstOrDefault(c => $"chain_{c.Id}" == selectedFilter)?.Name;
        storeToDelete = null; // Not deleting a single store
        modalTitle = "Confirm Bulk Deletion";
        modalMessage = $"Are you sure you want to delete ALL {stores.Count} store(s) from the chain '{chainName}'? " +
                      "The chain itself will remain, but all its stores will be permanently deleted. This action cannot be undone.";
        showDeleteModal = true;
    }

    private async Task ConfirmDelete()
    {
        try
        {
            // Check if this is a bulk delete (storeToDelete is null) or single delete
            if (storeToDelete == null && selectedFilter.StartsWith("chain_"))
            {
                // Bulk delete all stores from the chain using DeleteAllStoresAsync endpoint
                var chainIdString = selectedFilter.Replace("chain_", "");
                if (Guid.TryParse(chainIdString, out var chainId))
                {
                    // Get the chain to retrieve timestamps
                    var chain = availableChains.FirstOrDefault(c => c.Id == chainId);
                    if (chain != null)
                    {
                        await StoreService.DeleteAllStoresAsync(chainId);
                    }

                    showDeleteModal = false;

                    // Reload the list (should be empty now)
                    await LoadStores();
                }
            }
            else if (storeToDelete != null)
            {
                // Single store delete using DeleteStoreAsync endpoint
                await StoreService.DeleteStoreAsync(storeToDelete.Id);

                showDeleteModal = false;
                storeToDelete = null;

                // Reload the list
                await LoadStores();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete store(s): {ex.Message}";
            showDeleteModal = false;
        }
    }

    private void CancelDelete()
    {
        showDeleteModal = false;
        storeToDelete = null;
    }
}